rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Permitir lectura pública de negocios y productos
    match /businesses/{businessId} {
      allow read: if true;
      allow write: if request.auth != null;
      
      // Subcolección de notificaciones
      // Se sincronizan entre dispositivos del mismo usuario
      match /notifications/{notificationId} {
        // Lectura: usuarios autenticados del negocio
        allow read: if request.auth != null;
        
        // Crear: Cloud Functions o API backend (sin auth del cliente)
        allow create: if true;
        
        // Actualizar: permitir cambios en el campo 'read' desde cualquier dispositivo
        // También permitir 'updatedAt' para rastrear cuándo se actualizó
        allow update: if request.auth != null;
        
        // Eliminación no permitida (mantener historial)
        allow delete: if false;
      }
      
      // Subcolección de biblioteca de ingredientes
      match /ingredientLibrary/{ingredientId} {
        // Lectura: usuarios autenticados pueden leer ingredientes de su negocio
        allow read: if request.auth != null;
        // Escritura: usuarios autenticados pueden crear/actualizar/eliminar ingredientes
        allow write: if request.auth != null;
      }
      
      // Subcolección de biblioteca de ingredientes únicos
      match /businessIngredients/{ingredientId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
      
      // Subcolección de calificaciones
      match /ratings/{ratingId} {
        // Permitir lectura pública para verificar si una orden ya fue calificada
        allow read: if true;
        
        // Permitir consultas de agregación (necesario para count, avg, etc.)
        allow list, get: if true;
        
        // Cualquiera puede crear calificaciones (los clientes sin autenticación)
        allow create: if (
          // Validar que los campos requeridos estén presentes
          request.resource.data.keys().hasAll(['orderId', 'rating']) &&
          // Validar que el rating sea un número entre 1 y 5
          request.resource.data.rating is number &&
          request.resource.data.rating >= 1 &&
          request.resource.data.rating <= 5
        );
        
        // No permitir actualizaciones ni eliminaciones
        allow update, delete: if false;
      }
    }

    match /products/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Colección de clientes (permitir lectura/escritura para el flujo actual)
    match /clients/{document} {
      // Lectura pública (se usa para búsqueda por teléfono)
      allow read: if true;
      // Escribir clientes desde frontend (registro en checkout/manual)
      allow write: if true;
    }

    // Los pedidos pueden ser creados, leídos y editados sin autenticación (para checkout y acceso a "sus pedidos"), pero eliminación solo para autenticados
    match /orders/{document} {
      allow create, read, update: if true;
      allow delete: if request.auth != null;
    }

    // Colección para contadores de visitas por negocio
    // Documento ID = businessId
    // Permitir lecturas públicas y permitir incrementos controlados desde frontend.
    match /visits/{businessId} {
      // Lectura pública para mostrar métricas en admin y web
      allow read: if true;

      // Creación: autenticados pueden crear libremente.
      // Anónimos sólo pueden crear el documento inicial con count == 1
      // y opcionalmente incluir timestamps `createdAt` /`updatedAt` .
      allow create: if request.auth != null || (
        request.resource.data.keys().hasAll(['count']) &&
        request.resource.data.count is int &&
        request.resource.data.count == 1 &&
        // No permitir campos extras además de count y timestamps
        (request.resource.data.keys().hasOnly(['count']) ||
         request.resource.data.keys().hasOnly(['count','createdAt']) ||
         request.resource.data.keys().hasOnly(['count','updatedAt']) ||
         request.resource.data.keys().hasOnly(['count','createdAt','updatedAt']))
      );

      // Update: autenticados pueden actualizar libremente.
      // Anónimos sólo pueden modificar el contador y el timestamp `updatedAt` .
      // Permitimos esta operación cuando las únicas claves que se escriben
      // son `count`  y opcionalmente `updatedAt` . Esto permite usar
      // FieldValue.increment y serverTimestamp desde el cliente.
      allow update: if request.auth != null || (
        request.writeFields.size() > 0 &&
        request.writeFields.hasOnly(['count', 'updatedAt'])
      );

      // Borrar no permitido
      allow delete: if false;
    }

    // Colección de ubicaciones (direcciones de clientes)
    // Se usa en checkout para obtener ubicaciones vinculadas a un cliente
    match /ubicaciones/{document} {
      // Permitimos lectura pública para que el frontend (checkout) pueda
      // obtener las ubicaciones del cliente sin necesidad de auth.
      allow read: if true;
      // Escrituras permitidas sin autenticación para permitir guardado durante checkout (similar a clients)
      allow write: if true;
    }

    // Colección de deliveries (repartidores)
    // Acceso restringido a usuarios autenticados (admin/bussiness)
    match /deliveries/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Colección de zonas de cobertura
    match /coverageZones/{document} {
      // Lectura pública (se usa para calcular tarifas desde la app cliente)
      allow read: if true;
      // Escrituras sólo por usuarios autenticados (administración)
      allow write: if request.auth != null;
    }

    // Colección de Gastos
    // Acceso restringido a usuarios autenticados (admin/bussiness)
    match /expenses/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Colección de códigos QR
    match /qrCodes/{document} {
      // Lectura pública para que cualquier cliente pueda escanear
      allow read: if true;
      // Solo usuarios autenticados pueden crear y actualizar códigos
      allow create, update: if request.auth != null;
      // Permitir eliminación solo a usuarios autenticados
      allow delete: if request.auth != null;
    }

    // Colección de progreso de usuarios en códigos QR
    // Similar a ubicaciones: permitir lectura/escritura pública para clientes sin auth
    // Los clientes se identifican por su número de celular (userId)
    match /userQRProgress/{document} {
      // Lectura pública (similar a ubicaciones y clients)
      // Los clientes pueden consultar su progreso usando su celular como userId
      allow read: if true;
      
      // Escritura pública (similar a ubicaciones y clients)
      // Permitir crear y actualizar para que los clientes puedan registrar escaneos
      // sin necesidad de autenticación Firebase
      allow create, update: if true;
      
      // No permitir eliminación
      allow delete: if false;
    }


// Colección de progreso de checkout (sincronización en tiempo real desde frontend)
    match /checkoutProgress/{document} {
      // Lectura: pública (para que el monitor admin pueda ver sin auth, o el cliente vea su propio progreso)
      allow read: if true;

      // Escritura: pública (permitir que el cliente sin auth Firebase escriba su progreso durante checkout)
      // Puedes agregar validaciones más estrictas si quieres
      allow write: if true;

      // Opcional: si quieres restringir un poco más (recomendado en producción)
      // allow create, update: if 
      //   request.resource.data.keys().hasAll(['currentStep']) &&  // al menos debe tener paso actual
      //   request.resource.data.currentStep is int &&
      //   request.resource.data.currentStep >= 1 &&
      //   request.resource.data.currentStep <= 4;  // ajusta según tus pasos
    }


    // Colección de movimientos de stock de ingredientes
    // Acceso restringido a usuarios autenticados del negocio
    match /ingredientStockMovements/{document} {
      // Lectura: usuarios autenticados pueden leer movimientos de su negocio
      allow read: if request.auth != null &&
        request.auth.uid != null;
      
      // Escritura: usuarios autenticados pueden crear/actualizar movimientos
      // Se valida en la aplicación que pertenezcan al negocio correcto
      allow create, update: if request.auth != null &&
        request.auth.uid != null &&
        request.resource.data.businessId is string;
      
      // Eliminación: permitida para usuarios autenticados (para recuperación de stock al borrar órdenes)
      allow delete: if request.auth != null;
    }

    // Sistema de Referidos - Colección de links de referido
    match /referralLinks/{document} {
      // Lectura pública (necesario para verificar códigos y mostrar estadísticas)
      allow read: if true;
      
      // Escritura pública (permitir que usuarios sin auth generen links de referido)
      // La validación de datos se hace en la aplicación
      allow create, update: if true;
      
      // No permitir eliminación (mantener historial de referidos)
      allow delete: if false;
    }

    // Sistema de Referidos - Colección de créditos de usuarios
    match /userCredits/{document} {
      // Lectura pública (usuarios pueden ver sus créditos sin auth)
      allow read: if true;
      
      // Crear/actualizar: solo desde backend o usuarios autenticados
      // Los créditos se acreditan automáticamente al completar órdenes
      allow create, update: if request.auth != null;
      
      // No permitir eliminación (mantener historial de créditos)
      allow delete: if false;
    }

    // Sistema de Referidos - Colección de registros de referidos
    match /referralRecords/{document} {
      // Lectura: usuarios autenticados pueden ver registros
      allow read: if request.auth != null;
      
      // Crear: solo desde backend cuando se acredita un referido
      allow create: if request.auth != null;
      
      // No permitir actualización ni eliminación (registro inmutable)
      allow update, delete: if false;
    }
  }
}